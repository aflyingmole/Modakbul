<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Campground Detail</title>
</head>
<body>
<h2>Campground Detail</h2>

<!--달력로직-->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.js'></script>
<style>
    body {
        margin: 40px 10px;
        padding: 0;
        font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
        font-size: 14px;
    }
    #calendar {
        max-width: 600px;
        margin: 20px auto;
    }
    .selected {
        background-color: rgba(0, 255, 0, 0.3); /* 연한 초록색 */
    }
</style>
</head>
<!--<body>-->
<form action="/campgrounds/campsite" method="get" onsubmit="return validateForm();">
    <!-- Hidden inputs to hold selected dates -->
    <input type="hidden" id="checkInDate" name="checkInDate">
    <input type="hidden" id="checkOutDate" name="checkOutDate">

    <div class="date-display">
        <span>체크인 날짜: <span id="checkInDisplay">선택 안됨</span></span><br>
        <span>체크아웃 날짜: <span id="checkOutDisplay">선택 안됨</span></span>
    </div>

    <div id='calendar'></div>
    <button type="submit" style="margin-top: 20px;">예약하기</button>
</form>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');

        // URL에서 체크인, 체크아웃 날짜 가져오기
        const urlParams = new URLSearchParams(window.location.search);
        var checkInDate = urlParams.get('checkInDate');
        var checkOutDate = urlParams.get('checkOutDate');

        // 체크인, 체크아웃 날짜가 없는 경우 기본값 설정 (오늘 + 내일)
        var today = new Date();
        var todayStr = today.toISOString().slice(0, 10); // 오늘 날짜
        var tomorrow = new Date(today);
        tomorrow.setDate(today.getDate() + 1);
        var tomorrowStr = tomorrow.toISOString().slice(0, 10); // 내일 날짜

        if (!checkInDate) checkInDate = todayStr;
        if (!checkOutDate) checkOutDate = tomorrowStr;

        // 날짜를 input 요소에 설정
        document.getElementById('checkInDate').value = checkInDate;
        document.getElementById('checkOutDate').value = checkOutDate;

        // 화면에 표시될 날짜 설정
        document.getElementById('checkInDisplay').innerText = checkInDate;
        document.getElementById('checkOutDisplay').innerText = checkOutDate;

        var isCheckInSelected = false; // 체크인 날짜가 선택된 상태인지 확인
        var isCheckOutSelected = false; // 체크아웃 날짜가 선택된 상태인지 확인

        // FullCalendar 초기화
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            selectable: true,
            select: function(info) {
                var startDate = info.startStr;

                // 체크아웃이 선택된 상태일 때 새로운 체크인 날짜를 선택하도록 설정
                if (isCheckOutSelected) {
                    // 새로운 체크인 날짜로 설정하고, 체크아웃 초기화
                    checkInDate = startDate;
                    checkOutDate = new Date(new Date(checkInDate).setDate(new Date(checkInDate).getDate() + 1)).toISOString().slice(0, 10);
                    isCheckOutSelected = false;
                } else {
                    // 체크인 날짜가 아직 선택되지 않은 경우 체크인 날짜로 설정
                    if (!isCheckInSelected) {
                        checkInDate = startDate;
                        checkOutDate = new Date(new Date(checkInDate).setDate(new Date(checkInDate).getDate() + 1)).toISOString().slice(0, 10); // 체크아웃을 1박 2일 후로 설정
                        isCheckInSelected = true; // 체크인 날짜가 설정되었음을 표시
                    } else {
                        // 체크아웃 날짜는 체크인 이후 날짜만 선택 가능
                        if (new Date(startDate) > new Date(checkInDate)) {
                            checkOutDate = startDate;
                            isCheckOutSelected = true; // 체크아웃이 선택되었음을 표시
                        }
                    }
                }

                // 날짜 업데이트
                document.getElementById('checkInDate').value = checkInDate;
                document.getElementById('checkOutDate').value = checkOutDate;

                document.getElementById('checkInDisplay').innerText = checkInDate;
                document.getElementById('checkOutDisplay').innerText = checkOutDate;

                // 선택된 날짜 스타일링을 초기화하고 새롭게 반영
                calendar.getEvents().forEach(event => event.remove());

                if (checkInDate) {
                    // 체크인 날짜 표시
                    calendar.addEvent({
                        start: checkInDate,
                        end: checkOutDate ? new Date(new Date(checkOutDate).setDate(new Date(checkOutDate).getDate() + 1)).toISOString().slice(0, 10) : new Date(new Date(checkInDate).setDate(new Date(checkInDate).getDate() + 1)).toISOString().slice(0, 10),
                        display: 'background',
                        classNames: ['selected']
                    });
                }

                if (checkInDate && checkOutDate) {
                    // 체크인과 체크아웃 사이의 날짜 범위 표시
                    calendar.addEvent({
                        start: new Date(new Date(checkInDate).setDate(new Date(checkInDate).getDate() + 1)).toISOString().slice(0, 10),
                        end: new Date(checkOutDate).toISOString().slice(0, 10),
                        display: 'background',
                        classNames: ['selected']
                    });
                }
            },
            unselectAuto: false
        });

        // 초기 상태에서 체크인 및 체크아웃 날짜 반영
        calendar.addEvent({
            start: checkInDate,
            end: new Date(new Date(checkOutDate).setDate(new Date(checkOutDate).getDate() + 1)).toISOString().slice(0, 10),
            display: 'background',
            classNames: ['selected']
        });

        if (checkInDate && checkOutDate) {
            calendar.addEvent({
                start: new Date(new Date(checkInDate).setDate(new Date(checkInDate).getDate() + 1)).toISOString().slice(0, 10),
                end: new Date(checkOutDate).toISOString().slice(0, 10),
                display: 'background',
                classNames: ['selected']
            });
        }

        calendar.render();
    });

    function validateForm() {
        return true; // 폼을 제출할 수 있도록 true 반환
    }
</script>

<!--캠핑장 객실 정보-->
<p><strong>Campground Name:</strong> <span th:text="${campground.campgroundName}">Camp Name</span></p>
<!--<p><strong>Category:</strong> <span th:text="${campground.campgroundCategory.getCategoryName()}">Category</span></p>-->
<!--<p><strong>Location:</strong> <span th:text="${campground.location.getLocationName()}">Location</span></p>-->
<p><strong>Address:</strong> <span th:text="${campground.campgroundAddress}">Address</span></p>
<p><strong>Phone:</strong> <span th:text="${campground.phone}">123-456-7890</span></p>
<p><a th:href="@{/campgrounds}">Back to List</a></p>
</body>
</html>
