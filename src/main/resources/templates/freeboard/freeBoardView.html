<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>게시글 보기</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link rel="stylesheet" th:href="@{/css/header.css}">
<link rel="stylesheet" th:href="@{/css/freeBoardView.css}">
<link rel="stylesheet" th:href="@{/css/footer.css}">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
	<!-- 헤더 영역 -->
	<header th:replace="~{fragments/header :: header}"></header>

	<!-- 게시글 내용 영역 -->
	<section class="container my-5">
		<div class="card">
			<div class="card-header">
				<h4 class="card-title mb-3" th:text="${board.title}">게시글 제목</h4>
				<div th:if="${board.userId == userId}">
					<a th:href="@{/freeboard/freeBoardUpdate/{id}(id=${board.id})}"
						class="btn btn-outline-warning btn-sm me-2">수정</a> <a
						th:href="@{/freeboard/freeBoardDelete/{id}(id=${board.id})}"
						class="btn btn-outline-danger btn-sm">삭제</a>
				</div>
				<ul class="list-inline">
					<li class="list-inline-item"><strong>작성자:</strong> <span
						th:text="${board.userId}">작성자명</span></li>
					<li class="list-inline-item"><strong>작성일:</strong> <span
						th:text="${board.createdAt != null ? #temporals.format(board.createdAt, 'yyyy-MM-dd') : '날짜 없음'}"></span></li>
				</ul>
			</div>	
			
			<div id="postCarousel" class="carousel slide" data-bs-ride="carousel">
				<div class="carousel-indicators">
					<th:block th:each="image, iterStat : ${board.images}">
						<button type="button" data-bs-target="#postCarousel"
							th:data-bs-slide-to="${iterStat.index}"
							th:classappend="${iterStat.index == 0} ? 'active'"
							th:aria-current="${iterStat.index == 0} ? 'true' : 'false'"
							th:aria-label="'Slide ' + ${iterStat.index + 1}"></button>
					</th:block>
				</div>

				<div class="carousel-inner">
					<th:block th:each="image, iterStat : ${board.images}">
						<div class="carousel-item"
							th:classappend="${iterStat.index == 0} ? 'active'">
							<img
								th:src="@{/upload/{fileName}(fileName=${image?.saveFileName ?: 'default.jpg'})}"
								class="d-block w-100" th:alt="'Slide ' + ${iterStat.index + 1}">
						</div>
					</th:block>
					<th:block th:if="${#lists.isEmpty(board.images)}">
						<div class="carousel-item active">
							<img th:src="@{/upload/default.jpg}" class="d-block w-100"
								alt="기본 이미지">
						</div>
					</th:block>
				</div>

				<button class="carousel-control-prev" type="button"
					data-bs-target="#postCarousel" data-bs-slide="prev">
					<span class="carousel-control-prev-icon" aria-hidden="true"></span>
					<span class="visually-hidden">이전</span>
				</button>
				<button class="carousel-control-next" type="button"
					data-bs-target="#postCarousel" data-bs-slide="next">
					<span class="carousel-control-next-icon" aria-hidden="true"></span>
					<span class="visually-hidden">다음</span>
				</button>
			</div>

			<div class="card-body">
				<p class="card-text" th:text="${board.content}">게시글 상세 내용</p>
			</div>
		</div>

		<!-- 목록 버튼 추가 -->
		<div class="text-center my-4">
			<a th:href="@{/freeboard/freeBoardList}" class="btn btn-primary">게시글 리스트</a>
		</div>

		<!-- 댓글 보기 버튼 추가 -->
		<div class="text-center my-4">
			<button class="btn btn-primary" id="toggle-comments-btn">댓글 보기</button>
		</div>

		<!-- 댓글 영역 -->
		<div class="mt-5" id="comment-section" style="display: none;">
			<h5>댓글</h5>

			<!-- 댓글 입력 -->
			<form th:action="@{/freeboard/freeboardCommentWrite}" method="post">
				<input type="hidden" name="freeboardId" th:value="${board.id}" /> 
				<input type="hidden" name="memberId" th:value="${member.id}" />
				<div class="mb-3">
					<textarea class="form-control" name="content" rows="3"
						placeholder="댓글을 입력하세요"></textarea>
				</div>
				<button type="submit" class="btn btn-primary">댓글 작성</button>
			</form>

			<!-- 댓글 목록 -->
			<div class="comment-section mt-4"></div>

			<!-- 페이지네이션 영역 -->
			<nav aria-label="Page navigation" class="mt-4">
				<ul class="pagination"></ul>
			</nav>
		</div>
	</section>

	<footer th:replace="~{fragments/footer :: footer}"></footer>

	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
$(document).ready(function () {
    const boardId = /*[[${board.id}]]*/ null;
    const memberId = /*[[${member.id}]]*/ null;
    const userId = /*[[${userId}]]*/ null; 
    let currentPage = 1; // 현재 페이지 번호
    const pageSize = 10; // 페이지 당 댓글 수
    const commentSection = $('.comment-section');
	
    // 댓글 보기 버튼 클릭 이벤트
    $("#toggle-comments-btn").click(function () {
        const commentSection = $("#comment-section");
        if (commentSection.is(':hidden')) {
            commentSection.show();
            loadComments(currentPage); // 댓글을 불러오는 함수 호출
        } else {
            commentSection.hide();
        }
    });
	
    function loadComments(page) {
        $.ajax({
            url: `/freeboard/freeboardCommentList/${boardId}?page=${page}&size=${pageSize}`,
            method: 'GET',
            success: function (response) {
                console.log("댓글 응답:", response);
                const { comments, totalPages } = response; // 페이지네이션 정보 포함
                commentSection.empty(); // 기존 댓글 제거
				
                // 부모 댓글만 걸러내어 렌더링
                const parentComments = comments.filter(comment => !comment.parentId);

                // 자식 댓글을 부모 댓글에 연결하기 위한 Map
                const commentMap = {};
                comments.forEach(comment => {
                    commentMap[comment.id] = comment;
                    comment.children = []; // 자식 댓글 초기화
                });

                // 자식 댓글을 부모 댓글에 추가
                comments.forEach(comment => {
                    if (comment.parentId && commentMap[comment.parentId]) {
                        commentMap[comment.parentId].children.push(comment);
                    }
                });

                // 부모 댓글 렌더링
                renderComments(parentComments, 0);

                // 페이지네이션 생성
                createPagination(totalPages);
            },
            error: function (xhr, status, error) {
                console.error("댓글 불러오기 실패:", error);
            }
        });
    }

    // 댓글 렌더링 함수
    function renderComments(commentList, depth) {
        commentList.forEach(comment => {
            const date = new Date(comment.createdAt);
            const formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;

            const isOwner = comment.userId === userId;

            const commentElement = $(` 
                <div class="comment mb-3" style="margin-left: ${depth * 20}px;" data-comment-id="${comment.id}">
                    <strong>${comment.userId}</strong> <span>${formattedDate}</span>
                    <p class="comment-content">${comment.content}</p>
                    ${isOwner ? ` 
                        <button class="btn btn-sm btn-outline-warning edit-btn" data-comment-id="${comment.id}">수정</button> 
                        <button class="btn btn-sm btn-outline-danger delete-btn" data-comment-id="${comment.id}">삭제</button>
                    ` : ''}
                    <button class="btn btn-sm btn-link reply-btn">답글</button>
                    <div class="reply" style="display: none;">
                        <form class="reply-form mt-2">
                            <input type="hidden" name="parentId" value="${comment.parentId}" />
                            <input type="hidden" name="freeboardId" value="${boardId}" />
                            <input type="hidden" name="memberId" value="${memberId}" />
                            <div class="mb-2">
                                <textarea class="form-control" name="content" rows="2" placeholder="답글을 입력하세요"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">답글 작성</button>
                        </form>
                    </div>
                </div>
            `);

            commentSection.append(commentElement);

            // 자식 댓글이 있으면 재귀적으로 렌더링
            if (comment.children.length > 0) {
                renderComments(comment.children, depth + 1);
            }
        });
    }

    // 페이지네이션 생성 함수
    function createPagination(totalPages) {
        const pagination = $('.pagination');
        pagination.empty();
        for (let i = 1; i <= totalPages; i++) {
            const pageItem = $(` 
                <li class="page-item ${i === currentPage ? 'active' : ''}"> 
                    <a class="page-link" href="#">${i}</a>
                </li>
            `);
            pagination.append(pageItem);
        }

        // 페이지 클릭 이벤트 핸들러 (이벤트 위임 사용)
        pagination.off('click').on('click', '.page-link', function (e) {
            e.preventDefault();
            const selectedPage = parseInt($(this).text());
            if (selectedPage !== currentPage) {
                currentPage = selectedPage;
                loadComments(currentPage);
            }
        });
    }

    // 댓글 수정
    $(document).on('click', '.edit-btn', function () {
        const commentId = $(this).data('comment-id');
        const commentElement = $(`.comment[data-comment-id="${commentId}"]`);
        const content = commentElement.find('.comment-content').text();
        const editForm = $(` 
            <form class="edit-form mt-2">
                <input type="hidden" name="commentId" value="${commentId}" />
                <div class="mb-2">
                    <textarea class="form-control" name="content" rows="2">${content}</textarea>
                </div>
                <button type="submit" class="btn btn-primary">수정 완료</button>
                <button type="button" class="btn btn-secondary cancel-edit-btn">취소</button>
            </form>
        `);
        commentElement.append(editForm);
        $(this).hide(); // 수정 버튼 숨기기
    });

    // 댓글 수정 취소
    $(document).on('click', '.cancel-edit-btn', function () {
        const commentElement = $(this).closest('.comment');
        commentElement.find('.edit-btn').show(); // 수정 버튼 다시 보이기
        $(this).closest('.edit-form').remove(); // 수정 폼 제거
    });

    // 수정 폼 제출
    $(document).on('submit', '.edit-form', function (e) {
        e.preventDefault();
        const formData = $(this).serialize();
        $.ajax({
            url: '/freeboard/freeboardCommentUpdate',
            method: 'POST',
            data: formData,
            success: function () {
                loadComments(currentPage); // 댓글 목록 다시 불러오기
            }
        });
    });

    // 댓글 삭제
    $(document).on('click', '.delete-btn', function () {
        const commentId = $(this).data('comment-id');
        $.ajax({
            url: `/freeboard/freeboardCommentDelete/${commentId}`,
            method: 'DELETE',
            success: function () {
                loadComments(currentPage); // 댓글 목록 다시 불러오기
            }
        });
    });

    // 답글 버튼 클릭 이벤트
    $(document).on('click', '.reply-btn', function () {
        $(this).siblings('.reply').toggle(); // 답글 폼 토글
    });

    // 답글 작성 폼 제출
    $(document).on('submit', '.reply-form', function (e) {
        e.preventDefault();
        const formData = $(this).serialize();
        $.ajax({
            url: '/freeboard/freeboardCommentWrite',
            method: 'POST',
            data: formData,
            success: function () {
                loadComments(currentPage); // 댓글 목록 다시 불러오기
            }
        });
    });
});
</script>


</body>
</html>
