<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Campground List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <link rel="stylesheet" th:href="@{/css/freeBoardList.css}">
    <link rel="stylesheet" th:href="@{/css/footer.css}">
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.css' rel='stylesheet' />
    <link rel="stylesheet" th:href="@{/css/campground/calendar.css}">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.js'></script>
    

</head>
<body>
<!-- 헤더 영역 -->
<header th:replace="~{fragments/header :: header}"></header>

<!--메인 콘텐츠 영역-->

<form action="/campgrounds/list" method="get" onsubmit="return validateForm();">
    <!-- Search input for campground name or location -->
    <input type="text" name="query" placeholder="Search Campgrounds" required style="width: 300px; margin-bottom: 20px;">
    <button type="submit" style="margin-top: 20px;">Search Campgrounds</button>
    <!-- Hidden inputs to hold selected dates -->
    <input type="hidden" id="checkInDate" name="checkInDate">
    <input type="hidden" id="checkOutDate" name="checkOutDate">
    <div class="date-display">
        <span>체크인 날짜: <span id="checkInDisplay">선택 안됨</span></span><br>
        <span>체크아웃 날짜: <span id="checkOutDisplay">선택 안됨</span></span>
    </div>
</form>
<button id="toggleButton">보이기</button>
<div id='calendar'></div>
<table border="1">
    <thead>
    <tr>
        <th>ID</th>
        <th>Images</th>
        <th>Campground Name</th>
        <th>Location</th>
        <th>Details</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="campground : ${campgrounds}">
        <td th:text="${campground.id}">1</td>

        <!-- 캠핑장 이미지 슬라이드 (Bootstrap Carousel 사용) -->
        <td>
            <div id="carousel-${campground.id}" class="carousel slide">
                <div class="carousel-inner">
                    <!-- 이미지 반복 -->
                    <div th:each="image, iterStat : ${campground.getCampgroundImages()}"
                         th:classappend="${iterStat.index == 0} ? 'active' : ''" class="carousel-item">
                        <img th:src="@{/upload/{saveFileName}(saveFileName=${image.saveFileName})}"
                             class="d-block w-100" alt="캠핑장 이미지" style="max-width: 150px; max-height: 150px;">

                    </div>
                </div>
                <!-- 슬라이드 제어 버튼 -->
                <button class="carousel-control-prev" type="button" data-bs-target="#carousel-${campground.id}" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#carousel-${campground.id}" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>
        </td>

        <td th:text="${campground.campgroundName}">Camp Name</td>
        <td>
            <a th:href="@{/campgrounds/{id}(id=${campground.id})}" class="details-link">객실정보</a>
        </td>
        <td th:text="'총가격 : ' + ${(totalLowestPrices[campground.id])} + ' 원'">Total Price</td>
    </tr>
    </tbody>
</table>

<!-- 푸터 영역 -->
<footer th:replace="~{fragments/footer :: footer}"></footer>

<script>
    const calendarDiv = document.getElementById('calendar');
    const toggleButton = document.getElementById('toggleButton');

    let calendar;
    let checkInDate = '';
    let checkOutDate = '';
    let isCheckInSelected = false;
    let isCheckOutSelected = false;

    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');

        // URL에서 체크인, 체크아웃 날짜 가져오기
        const urlParams = new URLSearchParams(window.location.search);
        checkInDate = urlParams.get('checkInDate') || new Date().toISOString().slice(0, 10); // 오늘 날짜
        checkOutDate = urlParams.get('checkOutDate') || new Date(new Date().setDate(new Date().getDate() + 1)).toISOString().slice(0, 10); // 내일 날짜

        // 날짜를 input 요소에 설정
        document.getElementById('checkInDate').value = checkInDate;
        document.getElementById('checkOutDate').value = checkOutDate;

        // 화면에 표시될 날짜 설정
        document.getElementById('checkInDisplay').innerText = checkInDate;
        document.getElementById('checkOutDisplay').innerText = checkOutDate;

        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            selectable: true,
            select: function(info) {
                var startDate = info.startStr;

                // 체크아웃이 선택된 상태일 때 새로운 체크인 날짜를 선택하도록 설정
                if (isCheckOutSelected) {
                    checkInDate = startDate;
                    checkOutDate = new Date(new Date(checkInDate).setDate(new Date(checkInDate).getDate() + 1)).toISOString().slice(0, 10);
                    isCheckOutSelected = false;
                } else {
                    // 체크인 날짜가 아직 선택되지 않은 경우 체크인 날짜로 설정
                    if (!isCheckInSelected) {
                        checkInDate = startDate;
                        checkOutDate = new Date(new Date(checkInDate).setDate(new Date(checkInDate).getDate() + 1)).toISOString().slice(0, 10); // 체크아웃을 1박 2일 후로 설정
                        isCheckInSelected = true; // 체크인 날짜가 설정되었음을 표시
                    } else {
                        // 체크아웃 날짜는 체크인 이후 날짜만 선택 가능
                        if (new Date(startDate) > new Date(checkInDate)) {
                            checkOutDate = startDate;
                            isCheckOutSelected = true; // 체크아웃이 선택되었음을 표시
                        }
                    }
                }

                // 날짜 업데이트
                document.getElementById('checkInDate').value = checkInDate;
                document.getElementById('checkOutDate').value = checkOutDate;

                document.getElementById('checkInDisplay').innerText = checkInDate;
                document.getElementById('checkOutDisplay').innerText = checkOutDate;

                // 선택된 날짜 스타일링을 초기화하고 새롭게 반영
                calendar.getEvents().forEach(event => event.remove());

                if (checkInDate) {
                    // 체크인 날짜 표시
                    calendar.addEvent({
                        start: checkInDate,
                        end: new Date(new Date(checkOutDate).setDate(new Date(checkOutDate).getDate() + 1)).toISOString().slice(0, 10),
                        display: 'background',
                        classNames: ['selected']
                    });
                }

                if (checkInDate && checkOutDate) {
                    // 체크인과 체크아웃 사이의 날짜 범위 표시
                    calendar.addEvent({
                        start: new Date(new Date(checkInDate).setDate(new Date(checkInDate).getDate() + 1)).toISOString().slice(0, 10),
                        end: new Date(checkOutDate).toISOString().slice(0, 10),
                        display: 'background',
                        classNames: ['selected']
                    });
                }
            },
            unselectAuto: false
        });

        // 초기 상태에서 체크인 및 체크아웃 날짜 반영
        calendar.addEvent({
            start: checkInDate,
            end: new Date(new Date(checkOutDate).setDate(new Date(checkOutDate).getDate() + 1)).toISOString().slice(0, 10),
            display: 'background',
            classNames: ['selected']
        });

        if (checkInDate && checkOutDate) {
            calendar.addEvent({
                start: new Date(new Date(checkInDate).setDate(new Date(checkInDate).getDate() + 1)).toISOString().slice(0, 10),
                end: new Date(checkOutDate).toISOString().slice(0, 10),
                display: 'background',
                classNames: ['selected']
            });
        }

        calendar.render();
    });

    toggleButton.addEventListener('click', function() {
        if (calendarDiv.style.display === 'none') {
            calendarDiv.style.display = 'block';
            calendar.render(); // FullCalendar를 다시 렌더링
            toggleButton.textContent = '숨기기'; // 버튼 텍스트 변경
        } else {
            calendarDiv.style.display = 'none';
            toggleButton.textContent = '보이기'; // 버튼 텍스트 변경
        }
    });

    function validateForm() {
        return true; // 폼을 제출할 수 있도록 true 반환
    }
</script>
<!-- Bootstrap JS 추가 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.querySelectorAll('.details-link').forEach(link => {
        link.addEventListener('click', function(event) {
            // 체크인 및 체크아웃 날짜 가져오기
            const checkInDate = document.getElementById('checkInDate').value;
            const checkOutDate = document.getElementById('checkOutDate').value;

            // 링크의 href를 가져와서 수정
            let href = link.getAttribute('href');
            href += `?checkInDate=${encodeURIComponent(checkInDate)}&checkOutDate=${encodeURIComponent(checkOutDate)}`;

            // 수정된 href를 링크에 설정
            link.setAttribute('href', href);
        });
    });
</script>
</body>
</html>
