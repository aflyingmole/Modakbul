<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>채팅룸</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/header.css}">
	<link rel="stylesheet" th:href="@{/css/chatRoom.css}">
	<link rel="stylesheet" th:href="@{/css/footer.css}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <!-- 헤더 영역 -->
    <header th:replace="~{fragments/header :: header}"></header>

    <!-- 채팅룸 내용 영역 -->
    <section class="container my-5">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title mb-3" th:text="'채팅 - ' + ${chatRoom.campgroundId}">채팅룸 제목</h4>
                <div class="d-flex justify-content-between">
                    <div>
                        <span th:text="'현재 참여자: ' + ${chatRoom.memberId}">참여자</span>
                    </div>
                    <div>
                        <button class="btn btn-danger btn-sm" id="leave-chat-btn">채팅 나가기</button>
                    </div>
                </div>
            </div>

            <div class="card-body">
                <div class="message-section" style="max-height: 400px; overflow-y: auto;">
                    <div class="message-list">
                        <!-- 메시지 목록 -->
                        <th:block th:each="message : ${messages}">
                            <div class="message" th:class="${message.memberId == userId} ? 'text-end' : ''">
                                <strong th:text="${message.memberId}"></strong>
                                <span th:text="${message.content}"></span>
                                <small class="text-muted" th:text="${#temporals.format(message.createdAt, 'HH:mm:ss')}"></small>
                            </div>
                        </th:block>
                    </div>
                </div>

                <!-- 메시지 입력 폼 -->
                <form id="message-form">
                    <div class="input-group mt-3">
                        <input type="text" class="form-control" id="message-input" placeholder="메시지를 입력하세요" required>
                        <button type="submit" class="btn btn-send">전송</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 목록 버튼 추가 -->
        <div class="text-center my-4">
            <a th:href="@{/chat/chatList(campgroundId=${campgroundId})}" class="btn btn-chat-list">채팅 리스트</a>
        </div>
    </section>

    <footer th:replace="~{fragments/footer :: footer}"></footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
    $(document).ready(function () {
        const chatRoomId = /*[[${chatRoom.id}]]*/ null; // 채팅룸 ID
        const userId = /*[[${userId}]]*/ null; // 현재 사용자 ID

        // 웹소켓 연결
        const socket = new WebSocket(`ws://your-websocket-url/chatroom/${chatRoomId}`);

        // 웹소켓 메시지 수신
        socket.onmessage = function (event) {
            const message = JSON.parse(event.data);
            const messageElement = `
                <div class="message ${message.memberId == userId ? 'text-end' : ''}">
                    <strong>${message.memberId}</strong>
                    <span>${message.content}</span>
                    <small class="text-muted">${message.createdAt}</small>
                </div>
            `;
            $('.message-list').append(messageElement); // 새로운 메시지 추가
            $('.message-section').scrollTop($('.message-section')[0].scrollHeight); // 스크롤 최하단으로 이동
        };

        // 메시지 전송
        $('#message-form').on('submit', function (e) {
            e.preventDefault(); // 기본 제출 동작 방지
            const messageContent = $('#message-input').val();
            const message = {
                content: messageContent,
                memberId: userId
            };
            socket.send(JSON.stringify(message)); // 메시지를 웹소켓으로 전송
            $('#message-input').val(''); // 입력창 초기화
        });

        // 채팅 나가기 버튼 클릭 이벤트
        $('#leave-chat-btn').on('click', function () {
            socket.close(); // 웹소켓 연결 종료
            window.location.href = '/chat/chatList'; // 채팅 리스트로 이동
        });
    });
    </script>
</body>
</html>